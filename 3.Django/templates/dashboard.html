<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•­ê³µí¸ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: #fff !important;
        }
        
        .weather-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 8px 12px;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .weather-item {
            text-align: center;
            padding: 10px;
        }
        
        .weather-temp {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .weather-label {
            font-size: 0.75rem;
            opacity: 0.9;
        }
        
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.12);
        }
        
        .table {
            font-size: 0.95rem;
            margin-bottom: 0;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        
        .table tbody tr {
            transition: background-color 0.15s;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .status-on {
            background-color: #d1e7dd;
            color: #0f5132;
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-delay {
            background-color: #fff3cd;
            color: #664d03;
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-cancel {
            background-color: #f8d7da;
            color: #842029;
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 180px);
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .chat-msg {
            margin-bottom: 15px;
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-msg.user {
            justify-content: flex-end;
        }
        
        .chat-msg.bot {
            justify-content: flex-start;
        }
        
        .chat-msg.user > div {
            background: #0d6efd;
            color: white;
            padding: 10px 15px;
            border-radius: 15px 15px 0 15px;
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .chat-msg.bot > div {
            background: #e9ecef;
            color: #212529;
            padding: 10px 15px;
            border-radius: 15px 15px 15px 0;
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .chat-footer {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            background: white;
            border-radius: 0 0 12px 12px;
            display: flex;
            gap: 10px;
        }
        
        .chat-footer input {
            flex: 1;
            border-radius: 25px;
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            transition: border-color 0.2s;
        }
        
        .chat-footer input:focus {
            border-color: #0d6efd;
            outline: none;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
        }
        
        .chat-footer button {
            background: #0d6efd;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .chat-footer button:hover {
            background: #0b5ed7;
        }
        
        .airport-select {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            padding: 10px 15px;
            font-weight: 500;
        }
        
        .airport-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
        }
        
        .section-title {
            font-weight: 700;
            color: #212529;
            margin-top: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0d6efd;
        }
        
        .badge-custom {
            background: #e7f1ff;
            color: #0d6efd;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .last-updated {
            font-size: 0.85rem;
            color: #6c757d;
            font-style: italic;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="bi bi-airplane"></i> í•­ê³µí¸ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
            </span>
            <div class="d-flex align-items-center gap-3">
                {% if user.is_authenticated %}
                <span class="badge-custom">
                    <i class="bi bi-person-circle"></i> {{ user.username }}
                </span>
                <a class="btn btn-outline-light btn-sm" href="{% url 'logout' %}">ë¡œê·¸ì•„ì›ƒ</a>
                {% else %}
                <a class="btn btn-outline-light btn-sm" href="{% url 'login' %}">ë¡œê·¸ì¸</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="container-fluid py-4">
        <div class="row g-4">
            <!-- ì™¼ìª½ ì˜ì—­ -->
            <div class="col-lg-4" style="display: flex; flex-direction: column; height: calc(100vh - 180px); overflow-y: auto; padding-right: 10px;">
                <!-- ë‚ ì”¨ ì¹´ë“œ -->
                <div class="weather-card">
                    <div class="row text-center g-3">
                        <div class="col-4">
                            <div class="weather-temp" id="weatherTemp">--</div>
                            <div class="weather-label">ì˜¨ë„</div>
                        </div>
                        <div class="col-4">
                            <div class="weather-temp" id="weatherWind">--</div>
                            <div class="weather-label">ë°”ëŒ</div>
                        </div>
                        <div class="col-4">
                            <div class="weather-temp" id="weatherVis">--</div>
                            <div class="weather-label">ì‹œì •</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.95rem; opacity: 0.95;">
                        <i class="bi bi-geo-alt"></i> <span id="weatherLine">ê³µí•­ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                    </div>
                </div>

                <!-- ê³µí•­ ì„ íƒ -->
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="bi bi-building"></i> ê³µí•­ ì„ íƒ
                        </h6>
                        <select id="airportSelect" class="airport-select w-100">
                            <option value="ICN">ì¸ì²œ(ICN)</option>
                            <option value="GMP">ê¹€í¬(GMP)</option>
                            <option value="CJU">ì œì£¼(CJU)</option>
                            <option value="USN">ìš¸ì‚°(USN)</option>
                            <option value="RSU">ì—¬ìˆ˜(RSU)</option>
                            <option value="YNY">ì–‘ì–‘(YNY)</option>
                            <option value="PUS">ê¹€í•´|ë¶€ì‚°(PUS)</option>
                        </select>
                        <div class="last-updated" id="lastUpdated">ë§ˆì§€ë§‰ ê°±ì‹ : -</div>
                    </div>
                </div>

                <!-- ì¶œë°œ í˜„í™© -->
                <div class="card">
                    <div class="card-body">
                        <h6 class="section-title">
                            <i class="bi bi-arrow-up-right"></i> ì¶œë°œ í˜„í™©
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>í•­ê³µì‚¬</th>
                                        <th>ì¶œë°œì§€</th>
                                        <th>ëª©ì ì§€</th>
                                        <th>í¸ëª…</th>
                                        <th>ì‹œê°„</th>
                                        <th>ìƒíƒœ</th>
                                    </tr>
                                </thead>
                                <tbody id="depBody">
                                    <tr><td colspan="6" class="text-center py-3"><span class="spinner-border spinner-border-sm" role="status"></span></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ì˜¤ë¥¸ìª½ ì˜ì—­ -->
            <div class="col-lg-8">
                <!-- ì±—ë´‡ -->
                <div class="chat-container">
                    <div class="chat-header">
                        <i class="bi bi-chat-dots"></i> í•­ê³µí¸ ë³´ìƒ ì•ˆë‚´ ì±—ë´‡
                    </div>
                    <div class="chat-body" id="chatBody">
                        <div class="chat-msg bot">
                            <div>ì•ˆë…•í•˜ì„¸ìš” ğŸ‘‹ í•­ê³µí¸ ë³´ìƒ ì•ˆë‚´ ì±—ë´‡ì…ë‹ˆë‹¤. í•­ê³µí¸ ì§€ì—°/ê²°í•­ ê´€ë ¨ ë³´ìƒì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”!</div>
                        </div>
                    </div>
                    <div class="chat-footer">
                        <input id="chatInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                        <button id="chatSendBtn" type="button">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        const airports = [
            { stn: 113, name: "ì¸ì²œê³µí•­" },
            { stn: 110, name: "ê¹€í¬ê³µí•­" },
            { stn: 182, name: "ì œì£¼ê³µí•­" },
            { stn: 163, name: "ë¬´ì•ˆê³µí•­" },
            { stn: 151, name: "ìš¸ì‚°ê³µí•­" },
            { stn: 167, name: "ì—¬ìˆ˜ê³µí•­" },
            { stn: 92,  name: "ì–‘ì–‘ê³µí•­" },
        ];

        let idx = 0;

        function fmt1(x){
            if (x === null || x === undefined || Number.isNaN(x)) return "-";
            return Number(x).toFixed(1);
        }
        
        function fmtVis(m){
            if (m === null || m === undefined) return "-";
            const v = Number(m);
            if (v >= 10000) return "10km+";
            if (v >= 1000) return (v/1000).toFixed(1) + "km";
            return v + "m";
        }
        
        function pickVis(L, R){
            if (L == null && R == null) return null;
            if (L == null) return R;
            if (R == null) return L;
            return Math.min(L, R);
        }

        {% comment %} const airportCodeToStn = {
            "ICN": 113,
            "GMP": 110,
            "CJU": 182,
            "USN": 151,
            "RSU": 167,
            "YNY": 92,
            "PUS": 159
        }; {% endcomment %}

        const airportNames = {
            "ICN": "ì¸ì²œ",
            "GMP": "ê¹€í¬",
            "CJU": "ì œì£¼",
            "USN": "ìš¸ì‚°",
            "RSU": "ì—¬ìˆ˜",
            "YNY": "ì–‘ì–‘",
            "PUS": "ë¶€ì‚°"
        };

        async function updateWeather(airportCode){
            const name = airportNames[airportCode] || airportCode;
            document.getElementById("weatherLine").textContent = `${name} ë‚ ì”¨`;

            try{
            const r = await fetch(`/api/weather/?airport=${encodeURIComponent(airportCode)}`);
            if(!r.ok){
                // DBì— ì•„ì§ ê°’ì´ ì—†ìœ¼ë©´ 404(no_weather)
                document.getElementById("weatherTemp").textContent = "--";
                document.getElementById("weatherWind").textContent = "--";
                document.getElementById("weatherVis").textContent  = "--";
                return;
            }
            const w = await r.json();
            const vis = pickVis(w.L_VIS, w.R_VIS);

            document.getElementById("weatherTemp").textContent = fmt1(w.TA) + "Â°C";
            document.getElementById("weatherWind").textContent = fmt1(w.WS02) + " m/s";
            document.getElementById("weatherVis").textContent  = fmtVis(vis);

            // lastUpdated ë¼ë²¨ì€ â€œí•­ê³µí¸/ë‚ ì”¨â€ ë‘˜ ë‹¤ ì˜ë¯¸ë¡œ ì¨ë„ OK
            if (w.last_updated){
                document.getElementById("lastUpdated").textContent = "ë§ˆì§€ë§‰ ê°±ì‹ : " + w.last_updated;
            }
            }catch(e){
            console.warn("ë‚ ì”¨ ë¡œë“œ ì‹¤íŒ¨:", e);
            }
        }

        function statusClass(s){
            if (!s) return "status-on";
            if (s.includes("ì •ìƒ")) return "status-on";
            if (s.includes("ì§€ì—°")) return "status-delay";
            if (s.includes("ê²°í•­") || s.includes("ì·¨ì†Œ")) return "status-cancel";
            return "status-on";
        }

        function renderRows(rows, type, airport){
            if (!rows || rows.length === 0){
                return `<tr><td colspan="6" class="text-center py-3">ë°ì´í„° ì—†ìŒ</td></tr>`;
            }

            const slice = rows.slice(0, 8);

            if (type === "dep"){
                return slice.map(x => `
                <tr>
                    <td><small>${x.airline}</small></td>
                    <td><small>${airport}</small></td>
                    <td><small>${x.destination}</small></td>
                    <td><small><strong>${x.flight_no}</strong></small></td>
                    <td><small>${x.std.slice(0,2)}:${x.std.slice(2)}</small></td>
                    <td><span class="${statusClass(x.status)}">${x.status || "ì •ìƒ"}</span></td>
                </tr>
                `).join("");
            }

            return slice.map(x => `
                <tr>
                    <td><small>${x.airline}</small></td>
                    <td><small>${x.origin}</small></td>
                    <td><small><strong>${x.flight_no}</strong></small></td>
                    <td><small>${x.std.slice(0,2)}:${x.std.slice(2)}</small></td>
                    <td><span class="${statusClass(x.status)}">${x.status || "ì •ìƒ"}</span></td>
                </tr>
            `).join("");
        }
        async function refreshAirport(){
            const airportCode = document.getElementById("airportSelect").value;
            await updateWeather(airportCode);
            await loadBoards();
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("airportSelect").addEventListener("change", refreshAirport);

            refreshAirport();                 // ìµœì´ˆ 1íšŒ
            setInterval(refreshAirport, 30000); // 30ì´ˆë§ˆë‹¤ (ì›í•˜ë©´ 60ì´ˆë„ ê°€ëŠ¥)
        });

        async function loadBoards(){
            const airportCode = document.getElementById("airportSelect").value;
            const airportName = airportNames[airportCode] || airportCode;

            try {
                const url = `/api/departures/?airport=${encodeURIComponent(airportCode)}&limit=10`;
                console.log("ìš”ì²­ URL:", url);
                
                const r = await fetch(url);
                console.log("API ì‘ë‹µ ìƒíƒœ:", r.status);
                
                const text = await r.text();
                console.log("ì‘ë‹µ ë³¸ë¬¸:", text);
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error("JSON íŒŒì‹± ì‹¤íŒ¨:", e);
                    throw new Error("ì‘ë‹µì´ JSONì´ ì•„ë‹™ë‹ˆë‹¤");
                }
                
                if (!r.ok) throw new Error(`API ì˜¤ë¥˜: ${r.status}`);
                
                if (data.last_updated){
                    document.getElementById("lastUpdated").textContent =
                        "ë§ˆì§€ë§‰ ê°±ì‹ : " + data.last_updated;
                }
                
                if (data.departures && data.departures.length > 0) {
                    document.getElementById("depBody").innerHTML = renderRows(data.departures, "dep", airportName);
                } else {
                    document.getElementById("depBody").innerHTML = `<tr><td colspan="6" class="text-center py-3">í•´ë‹¹ ê³µí•­ì˜ ì¶œë°œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>`;
                }
            } catch (e) {
                console.error("ì¶œë°œ í˜„í™© ë¡œë“œ ì‹¤íŒ¨:", e);
                document.getElementById("depBody").innerHTML = `<tr><td colspan="6" class="text-center py-3">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</td></tr>`;
            }
        }
        let refreshTimer = null;

        document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("airportSelect").addEventListener("change", async () => {
            await refreshAirport();               // âœ… ê³µí•­ ë°”ê¾¸ë©´ ì¦‰ì‹œ ê°±ì‹ 
        });

        refreshAirport();                       // âœ… ìµœì´ˆ ë¡œë“œ

        refreshTimer = setInterval(() => {
            refreshAirport();                     // âœ… ì„ íƒëœ ê³µí•­ë§Œ ì£¼ê¸° ê°±ì‹ 
        }, 30000);
        });

        function appendMessage(text, sender){
            const body = document.getElementById("chatBody");

            const div = document.createElement("div");
            div.className = "chat-msg " + sender;
            
            const labelDiv = document.createElement("div");
            labelDiv.style.fontSize = "0.75rem";
            labelDiv.style.marginBottom = "4px";
            labelDiv.style.fontWeight = "600";
            labelDiv.style.opacity = "0.7";
            labelDiv.textContent = sender === "bot" ? "ğŸ¤– ì±—ë´‡" : "ğŸ‘¤ ë‚˜";
            div.appendChild(labelDiv);
            
            const msgDiv = document.createElement("div");
            msgDiv.textContent = text;
            div.appendChild(msgDiv);

            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

        async function sendChatToServer(message, airport){
            const r = await fetch("/api/chat/", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ message, airport })
            });

            if (!r.ok){
                throw new Error("ì„œë²„ ì˜¤ë¥˜");
            }

            const data = await r.json();
            return data.reply;
        }

        async function handleSend(){
            const input = document.getElementById("chatInput");
            const airport = document.getElementById("airportSelect").value;
            const msg = input.value.trim();
            if (!msg) return;

            input.value = "";

            appendMessage(msg, "user");
            appendMessage("ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...", "bot");

            try {
                const reply = await sendChatToServer(msg, airport);

                const body = document.getElementById("chatBody");
                body.removeChild(body.lastChild);

                appendMessage(reply, "bot");
            } catch (e) {
                const body = document.getElementById("chatBody");
                body.removeChild(body.lastChild);
                appendMessage("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message, "bot");
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("chatSendBtn")
                .addEventListener("click", handleSend);

            document.getElementById("chatInput")
            .addEventListener("keydown", e => {
                if (e.key === "Enter") handleSend();
            });
        });
    </script>
</body>
</html>
